<!doctype html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Password Management - SSO Documentation</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'bg-dark': 'var(--bg-app)',
            'sidebar-dark': 'var(--bg-sidebar)',
            'border-dark': 'var(--border-color)',
            'text-primary': 'var(--text-primary)',
            'text-secondary': 'var(--text-secondary)',
            'accent': 'var(--color-accent)',
            'text-header': 'var(--text-header)',
              'bg-surface': 'var(--bg-surface)',
            'text-code': 'var(--text-code)',
            'bg-active': 'var(--bg-active)',
            'text-on-active': 'var(--text-on-active)',
            },
          fontFamily: {
            'sans': ['"Inter"', 'system-ui', 'sans-serif'],
          },
          spacing: {
            'sidebar': '300px',
          }
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer base {
        body {
          @apply bg-bg-dark text-text-primary font-sans antialiased;
        }
        h1 {
            @apply text-3xl font-semibold text-text-header mb-6;
        }
        h2 {
            @apply text-2xl font-semibold text-text-header mt-12 mb-4 border-b border-border-dark pb-2;
        }
        h3 {
            @apply text-xl font-semibold text-text-header mt-8 mb-3;
        }
        h4 {
            @apply text-lg font-medium text-text-header mt-6 mb-2;
        }
        p {
            @apply leading-7 text-text-primary mb-4;
        }
        ul {
            @apply list-disc list-outside pl-6 mb-4 space-y-1;
        }
        ol {
            @apply list-decimal list-outside pl-6 mb-4 space-y-1;
        }
        li {
            @apply text-text-primary;
        }
        code {
            @apply font-mono text-sm bg-bg-surface text-text-code px-1.5 py-0.5 rounded border border-gray-700;
        }
        pre {
            @apply bg-bg-surface border border-border-dark p-4 rounded-md overflow-x-auto mb-6 text-sm text-text-code;
        }
        /* Table Styles */
        table {
            @apply w-full text-left border-collapse border border-border-dark mb-6 mt-4;
        }
        th {
            @apply border-b border-border-dark bg-bg-surface p-3 text-sm font-semibold text-text-header;
        }
        td {
            @apply border-b border-border-dark p-3 text-sm text-text-primary align-top;
        }
        tr:last-child td {
            @apply border-b-0;
        }
        
        /* Sources Box */
        .sources-box {
            @apply mt-4 p-3 bg-bg-surface border border-border-dark rounded text-xs font-mono text-text-secondary;
        }
        .sources-label {
            @apply font-bold text-gray-400 block mb-1 uppercase tracking-wider text-[10px];
        }
      }
    </style>
</head>

<body>

  <!-- Mobile Header -->
  <header
    class="lg:hidden flex items-center justify-between px-6 py-4 border-b border-border-dark sticky top-0 bg-bg-dark/80 backdrop-blur-md z-50">
    <span class="font-bold text-lg text-white">SSO Docs</span>
    <button id="mobile-menu-btn" class="text-text-secondary hover:text-white p-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
  </header>

  <div class="flex min-h-screen relative">
    <!-- Sidebar -->
    <nav id="sidebar"
      class="fixed inset-y-0 left-0 w-sidebar h-screen overflow-y-auto border-r border-border-dark p-6 bg-sidebar-dark transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-40 lg:static lg:h-auto lg:border-r-0 lg:block">
      <!-- Content populated by main.js -->
    </nav>

    <!-- Main Content -->
    <main class="flex-1 lg:ml-sidebar max-w-4xl mx-auto pt-10 pb-32 px-8">

      <div class="mb-2 text-sm text-text-secondary font-medium uppercase tracking-wider">Authentication & Authorization
      </div>

      <h1>Gestión de Contraseñas</h1>

      <section class="prose prose-invert max-w-none">

        <h2>Propósito y Alcance</h2>
        <p>
          Este documento describe el sistema de gestión de contraseñas en la aplicación SSO, cubriendo el hashing de
          contraseñas, almacenamiento, flujos de restablecimiento y el mecanismo de contraseña predeterminada. Detalla
          cómo se crean, validan y cambian las contraseñas tanto para usuarios internos como externos.
        </p>
        <p>
          Para información sobre flujos de autenticación y validación de credenciales, ver <a
            href="authentication-flow.html" class="text-accent hover:underline">Flujo de Autenticación</a>. Para
          detalles sobre la integración con Active Directory para usuarios externos, ver <a
            href="active-directory-integration.html" class="text-accent hover:underline">Integración con Active
            Directory</a>.
        </p>

        <h2>Almacenamiento y Hashing de Contraseñas</h2>
        <p>
          El sistema utiliza BCrypt para el hashing de contraseñas, proporcionando protección criptográfica fuerte
          contra ataques de tablas arcoíris y fuerza bruta. Todas las contraseñas son hasheadas antes del
          almacenamiento, y el sistema nunca almacena contraseñas en texto plano en la base de datos.
        </p>

        <h3>Implementación de Hashing</h3>
        <p>
          La entidad <code>User</code> almacena contraseñas en el campo <code>Password</code> como hashes BCrypt. Al
          crear nuevos usuarios o restablecer contraseñas, el sistema usa <code>BCrypt.Net.BCrypt.HashPassword()</code>
          para generar hashes seguros:
        </p>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.BusinessLayer/Services/General/UserService.cs (82-86) • SSO.Api/Controllers/General/UserController.cs
          (138, 175)
        </div>

        <div
          class="my-6 p-4 border border-border-dark border-dashed rounded bg-bg-surface text-center text-text-secondary text-sm">
          [Diagrama: Implementación de Hashing]
        </div>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.BusinessLayer/Services/General/UserService.cs (82-86) • SSO.Api/Controllers/General/UserController.cs
          (115-161) • SSO.Api/Controllers/General/UserController.cs (163-203)
        </div>

        <h3>Verificación de Contraseñas Durante la Autenticación</h3>
        <p>Durante el inicio de sesión, el sistema de autenticación verifica las contraseñas de manera diferente según
          la bandera <code>User.IsExternal</code>:</p>
        <table>
          <thead>
            <tr>
              <th>Tipo de Usuario</th>
              <th>Método de Verificación</th>
              <th>Implementación</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Interno (IsExternal = false)</td>
              <td>Comparación de hash BCrypt</td>
              <td><code>BCrypt.Verify(password, User.Password)</code></td>
            </tr>
            <tr>
              <td>Externo (IsExternal = true)</td>
              <td>Delegación a Active Directory</td>
              <td><code>ActiveDirectoryService.ValidateCredentials()</code></td>
            </tr>
          </tbody>
        </table>
        <p>
          Para usuarios internos, la contraseña en texto plano enviada durante el inicio de sesión se compara contra el
          hash BCrypt almacenado usando <code>BCrypt.Verify()</code>. Este método realiza una comparación de tiempo
          constante para prevenir ataques de temporización.
        </p>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          Referenciado en el diagrama de flujo de autenticación de alto nivel
        </div>

        <h2>Contraseña Predeterminada del Sistema</h2>
        <p>
          El sistema mantiene una contraseña predeterminada configurable almacenada en
          <code>SystemSettings.DefaultSystemPassword</code>. Esta contraseña predeterminada se aplica en dos escenarios:
        </p>
        <ul class="list-disc pl-6 space-y-1">
          <li><strong>Creación de Nuevo Usuario:</strong> Al crear un nuevo usuario mediante
            <code>UserService.Add()</code>, el sistema automáticamente hashea la contraseña predeterminada y la asigna
          </li>
          <li><strong>Restablecimiento de Contraseña:</strong> Cuando un administrador restablece la contraseña de un
            usuario mediante el endpoint <code>/PasswordReset</code></li>
        </ul>

        <h3>Configuración de Contraseña Predeterminada</h3>
        <p>La contraseña predeterminada se configura en SystemSettings y se inyecta mediante el patrón
          <code>IOptions&lt;SystemSettings&gt;</code>:</p>

        <div
          class="my-6 p-4 border border-border-dark border-dashed rounded bg-bg-surface text-center text-text-secondary text-sm">
          [Diagrama: Configuración de SystemSettings]
        </div>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.BusinessLayer/Services/General/UserService.cs (24-34) • SSO.Api/Controllers/General/UserController.cs
          (32-50)
        </div>

        <p>
          El valor de la contraseña predeterminada es "Inicio01" (referenciado en el correo electrónico de
          restablecimiento de contraseña en la línea 186 de UserController).
        </p>

        <h3>Asignación de Contraseña a Nuevo Usuario</h3>
        <p>Cuando se crea un nuevo usuario a través de <code>UserService.Add()</code>:</p>
        <ol class="list-decimal pl-6 space-y-1">
          <li>El método obtiene <code>_systemSettings.DefaultSystemPassword</code></li>
          <li>La hashea usando <code>BCrypt.HashPassword()</code></li>
          <li>Asigna el hash a <code>entity.Password</code></li>
          <li>Llama a <code>base.Add()</code> para persistir el usuario</li>
        </ol>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.BusinessLayer/Services/General/UserService.cs (82-86)
        </div>

        <h2>Flujo de Restablecimiento de Contraseña</h2>
        <p>
          El flujo de restablecimiento de contraseña permite a los administradores restablecer la contraseña de un
          usuario a la contraseña predeterminada del sistema. El proceso es controlado por la bandera
          <code>User.ResetPassword</code>, que obliga a un cambio de contraseña obligatorio en el próximo inicio de
          sesión del usuario.
        </p>

        <h3>Endpoint de Restablecimiento</h3>
        <p>El endpoint <code>PATCH /api/User/PasswordReset/{usuarioId}</code> implementa el flujo de restablecimiento:
        </p>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.Api/Controllers/General/UserController.cs (163-203)
        </div>

        <h3>Pasos del Proceso de Restablecimiento</h3>
        <ul class="list-disc pl-6 space-y-1">
          <li><strong>Validar Usuario:</strong> Cargar la entidad User con la propiedad de navegación Person (línea
            168-170)</li>
          <li><strong>Hashear Contraseña Predeterminada:</strong> Generar hash BCrypt de
            SystemSettings.DefaultSystemPassword (línea 175)</li>
          <li><strong>Establecer Bandera de Restablecimiento:</strong> Establecer User.ResetPassword = true para obligar
            el cambio de contraseña (línea 176)</li>
          <li><strong>Persistir Cambios:</strong> Guardar actualizaciones en la base de datos (línea 178)</li>
          <li><strong>Notificación por Correo:</strong> Enviar correo a User.Person.Email con instrucciones de
            restablecimiento (líneas 179-191)</li>
        </ul>

        <h3>Notificación por Correo Electrónico</h3>
        <p>El correo de restablecimiento informa al usuario que su contraseña ha sido restablecida y proporciona la
          contraseña predeterminada:</p>
        <ul class="list-none pl-6 font-mono text-sm bg-bg-surface p-3 rounded mb-4">
          <li><strong>Asunto:</strong> "Reinicio De Usuario"</li>
          <li><strong>Proceso:</strong> "Contraseña de Usuario Reiniciada"</li>
          <li><strong>Cuerpo:</strong> Instruye al usuario a iniciar sesión con la contraseña predeterminada "Inicio01"
            y cambiarla</li>
        </ul>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.Api/Controllers/General/UserController.cs (179-192)
        </div>

        <h2>Flujo de Cambio de Contraseña</h2>
        <p>
          El flujo de cambio de contraseña permite a los usuarios establecer una nueva contraseña después de un
          restablecimiento. Este endpoint está protegido por la validación de la bandera ResetPassword.
        </p>

        <h3>Endpoint de Cambio de Contraseña</h3>
        <p>El endpoint <code>POST /api/User/ChangePassword</code> procesa los cambios de contraseña:</p>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.Api/Controllers/General/UserController.cs (115-161)
        </div>

        <h3>DTO de Solicitud de Cambio de Contraseña</h3>
        <p>El <code>ChangePasswordRequestDto</code> contiene:</p>
        <ul class="list-disc pl-6 mb-2">
          <li><code>UserId</code>: El ID del usuario que cambia su contraseña</li>
          <li><code>NewPassword</code>: La nueva contraseña en texto plano a ser hasheada</li>
        </ul>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.Api/Controllers/General/UserController.cs (116)
        </div>

        <h3>Reglas de Validación</h3>
        <p>El endpoint aplica las siguientes validaciones:</p>
        <table>
          <thead>
            <tr>
              <th>Validación</th>
              <th>Condición</th>
              <th>Respuesta</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Modelo Nulo</td>
              <td>model is null</td>
              <td>400 Bad Request: "Argumentos de la llamada nulos o faltantes"</td>
            </tr>
            <tr>
              <td>Usuario No Encontrado</td>
              <td>Person.User.Id != model.UserId</td>
              <td>404 Not Found: "El registro no existe"</td>
            </tr>
            <tr>
              <td>No Requiere Restablecimiento</td>
              <td>User.ResetPassword = false</td>
              <td>400 Bad Request: "La contraseña no necesita ser cambiada"</td>
            </tr>
          </tbody>
        </table>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.Api/Controllers/General/UserController.cs (120-136)
        </div>

        <h3>Proceso de Cambio de Contraseña</h3>
        <ol class="list-decimal pl-6 space-y-1">
          <li><strong>Cargar Datos del Usuario:</strong> Consultar tabla People con Include(x => x.User) para cargar la
            relación de usuario (líneas 125-127)</li>
          <li><strong>Verificar Bandera de Restablecimiento:</strong> Verificar que User.ResetPassword = true,
            rechazando si es falso (líneas 133-136)</li>
          <li><strong>Hashear Nueva Contraseña:</strong> Generar hash BCrypt de model.NewPassword (línea 138)</li>
          <li><strong>Limpiar Bandera de Restablecimiento:</strong> Establecer User.ResetPassword = false para permitir
            inicio de sesión normal (línea 139)</li>
          <li><strong>Persistir Cambios:</strong> Guardar actualizaciones mediante SaveChangesAsync() (línea 141)</li>
          <li><strong>Retornar Éxito:</strong> Construir payload con PersonDto e información de token (líneas 142-149)
          </li>
        </ol>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.Api/Controllers/General/UserController.cs (125-149)
        </div>

        <h2>Integración con Autenticación</h2>
        <p>
          El sistema de gestión de contraseñas se integra con el flujo de autenticación mediante la aplicación de la
          bandera ResetPassword.
        </p>

        <h3>Puerta de Autenticación</h3>
        <p>Durante el proceso de autenticación, el sistema verifica la bandera ResetPassword:</p>

        <div
          class="my-6 p-4 border border-border-dark border-dashed rounded bg-bg-surface text-center text-text-secondary text-sm">
          [Diagrama: Puerta de Autenticación y Bandera ResetPassword]
        </div>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          Referenciado en el flujo de autenticación de alto nivel (Diagrama 3)
        </div>

        <h3>Comportamiento de la Bandera</h3>
        <table>
          <thead>
            <tr>
              <th>Estado de Bandera</th>
              <th>Comportamiento de Autenticación</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>ResetPassword = true</td>
              <td>El usuario es redirigido a la ruta /change-password con estado 307 Temporary Redirect</td>
            </tr>
            <tr>
              <td>ResetPassword = false</td>
              <td>La autenticación normal procede, se genera el token JWT</td>
            </tr>
          </tbody>
        </table>
        <p>
          Esta aplicación asegura que los usuarios con contraseñas restablecidas no puedan acceder al sistema hasta que
          establezcan una nueva contraseña.
        </p>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          Diagrama de autenticación de alto nivel (Diagrama 3 en descripción general)
        </div>

        <h2>Resumen de Endpoints API</h2>

        <h3>Restablecimiento de Contraseña</h3>
        <p><strong>Endpoint:</strong> <code>PATCH /api/User/PasswordReset/{usuarioId}</code></p>
        <p><strong>Autorización:</strong> Requiere autenticación (heredado de BaseController)</p>
        <p><strong>Parámetros de Solicitud:</strong> <code>usuarioId</code> (path): ID del usuario a restablecer</p>
        <p><strong>Respuesta:</strong></p>
        <pre><code class="language-json">{
  "message": "La clave se reinició con éxito. [Clave por defecto: 'Inicio01']"
}</code></pre>
        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.Api/Controllers/General/UserController.cs (163-203)
        </div>

        <h3>Cambio de Contraseña</h3>
        <p><strong>Endpoint:</strong> <code>POST /api/User/ChangePassword</code></p>
        <p><strong>Autorización:</strong> Requiere autenticación</p>
        <p><strong>Cuerpo de Solicitud:</strong></p>
        <pre><code class="language-json">{
  "UserId": 123,
  "NewPassword": "NuevaContraseñaSegura123"
}</code></pre>
        <p><strong>Respuesta:</strong></p>
        <pre><code class="language-json">{
  "data": {
    "TokenTipo": "Bearer",
    "ApiKey": "...",
    "Persona": { /* PersonDto */ }
  }
}</code></pre>
        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.Api/Controllers/General/UserController.cs (115-161)
        </div>

        <h2>Consideraciones de Seguridad</h2>

        <h3>Factor de Trabajo de BCrypt</h3>
        <p>
          El sistema usa el factor de trabajo predeterminado de BCrypt, que proporciona un equilibrio entre seguridad y
          rendimiento. BCrypt automáticamente incluye un salt en cada hash, eliminando la necesidad de almacenamiento de
          salt por separado.
        </p>

        <h3>Correo de Restablecimiento de Contraseña</h3>
        <p>
          El correo de restablecimiento de contraseña incluye explícitamente la contraseña predeterminada "Inicio01" en
          texto plano. Aunque esto simplifica la experiencia del usuario, significa que:
        </p>
        <ul class="list-disc pl-6 space-y-1">
          <li>La transmisión de correo debe ser asegurada (TLS/SSL)</li>
          <li>Las contraseñas predeterminadas deben cambiarse inmediatamente</li>
          <li>El compromiso del correo expone la contraseña temporal</li>
        </ul>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.Api/Controllers/General/UserController.cs (184-186)
        </div>

        <h3>Contraseña Predeterminada en Creación de Usuario</h3>
        <p>
          Todos los nuevos usuarios reciben la misma contraseña predeterminada mediante <code>UserService.Add()</code>.
          Esto crea una preocupación de seguridad:
        </p>
        <ul class="list-disc pl-6 space-y-1">
          <li>Los administradores deben activar inmediatamente el restablecimiento de contraseña para nuevos usuarios
          </li>
          <li>La contraseña predeterminada no debe ser fácilmente adivinable</li>
          <li>Considerar implementar un mecanismo de expiración de contraseña temporal</li>
        </ul>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.BusinessLayer/Services/General/UserService.cs (82-86)
        </div>

        <h2>Entidades Relacionadas</h2>

        <h3>Campos de la Entidad User</h3>
        <p>El sistema de gestión de contraseñas depende de los siguientes campos de la entidad User:</p>
        <table>
          <thead>
            <tr>
              <th>Campo</th>
              <th>Tipo</th>
              <th>Propósito</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Password</td>
              <td>string</td>
              <td>Hash BCrypt de la contraseña del usuario</td>
            </tr>
            <tr>
              <td>ResetPassword</td>
              <td>bool</td>
              <td>Bandera que indica requisito de cambio de contraseña forzado</td>
            </tr>
            <tr>
              <td>IsExternal</td>
              <td>bool</td>
              <td>Determina si la contraseña se valida mediante AD o BCrypt</td>
            </tr>
            <tr>
              <td>IsLocked</td>
              <td>bool</td>
              <td>Estado de bloqueo de cuenta, verificado antes de la validación de contraseña</td>
            </tr>
          </tbody>
        </table>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          Referenciado en SSO.Api/Controllers/General/UserController.cs (133-139)
        </div>

        <h3>Configuración de SystemSettings</h3>
        <p>La clase SystemSettings proporciona configuración para la gestión de contraseñas:</p>
        <table>
          <thead>
            <tr>
              <th>Propiedad</th>
              <th>Propósito</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>DefaultSystemPassword</td>
              <td>La contraseña predeterminada asignada a nuevos usuarios y durante restablecimientos</td>
            </tr>
          </tbody>
        </table>

        <div class="sources-box">
          <span class="sources-label">Fuentes:</span>
          SSO.BusinessLayer/Services/General/UserService.cs (24) • SSO.Api/Controllers/General/UserController.cs (32)
        </div>

      </section>
    </main>
  </div>

  <script src="./main.js"></script>
</body>

</html>